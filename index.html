<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estoque Local Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        .registro-card { border-left: 4px solid #16a34a; transition: all 0.2s; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <nav class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <h1 class="font-bold uppercase tracking-tight">SISTEMA DE ESTOQUE</h1>
        <button onclick="exportarDados()" class="text-xs bg-blue-800 hover:bg-blue-900 px-3 py-1 rounded transition-colors">Exportar JSON</button>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <section class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">1. Gerenciar Locais</h2>
            <div class="flex gap-2 mb-3">
                <input id="plat_cod" type="text" placeholder="C贸d. Ex: A1" class="border p-2 rounded w-1/3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <input id="plat_desc" type="text" placeholder="Descri莽茫o" class="border p-2 rounded w-1/2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <button id="btn_add_prat" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-700">+</button>
            </div>
            <select id="select_prateleira" class="w-full p-3 border rounded-lg bg-gray-50 font-medium text-gray-700">
                <option value="">-- Selecione a Prateleira --</option>
            </select>
        </section>

        <section class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">2. Entrada de Material</h2>
            <div id="reader" class="mb-4"></div> 
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input id="item_cod" type="text" placeholder="C贸digo do Item" class="flex-1 border-2 border-blue-50 p-3 rounded-xl font-mono text-lg focus:border-blue-500 outline-none">
                    <button onclick="iniciarScanner()" class="bg-gray-100 border p-3 rounded-xl hover:bg-gray-200"></button>
                </div>
                <button onclick="registrarEstoque()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-md active:scale-95 transition-all">
                    SALVAR REGISTRO
                </button>
            </div>
        </section>

        <section class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 border-t-4 border-t-orange-400">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3 text-orange-600">3. Pesquisar Item</h2>
            <div class="relative">
                <input id="input_busca" type="text" oninput="pesquisar()" placeholder="Digite o c贸digo para localizar..." 
                       class="w-full border-2 border-orange-100 p-3 rounded-xl pl-10 focus:border-orange-400 outline-none">
                <span class="absolute left-3 top-3.5 opacity-30"></span>
            </div>
        </section>

        <section>
            <h2 id="titulo_lista" class="text-xs font-bold text-gray-400 uppercase mb-2 px-1">ltimos Lan莽amentos</h2>
            <div id="lista_estoque" class="space-y-2">
                </div>
        </section>

    </main>

    <script>
        const db = new Dexie("EstoqueDB");
        db.version(1).stores({
            prateleiras: "++id, &codigo, descricao",
            estoque: "++id, codigo_item, data, hora, codigo_prateleira"
        });

        db.open().then(() => {
            carregarPrateleiras();
            carregarEstoque();
        }).catch(err => alert("Erro: " + err.message));

        document.getElementById('btn_add_prat').addEventListener('click', async () => {
            const inputCod = document.getElementById('plat_cod');
            const cod = inputCod.value.trim().toUpperCase();
            if(!cod) return;
            try {
                await db.prateleiras.add({ codigo: cod, descricao: document.getElementById('plat_desc').value.trim() });
                inputCod.value = '';
                document.getElementById('plat_desc').value = '';
                await carregarPrateleiras();
            } catch (e) { alert("Este local j谩 existe!"); }
        });

        async function carregarPrateleiras() {
            const prats = await db.prateleiras.toArray();
            const select = document.getElementById('select_prateleira');
            select.innerHTML = '<option value="">-- Selecione a Prateleira --</option>' + 
                prats.map(p => `<option value="${p.codigo}">${p.codigo}</option>`).join('');
        }

        async function registrarEstoque() {
            const item = document.getElementById('item_cod').value.trim();
            const prat = document.getElementById('select_prateleira').value;
            if(!item || !prat) return alert("Preencha o c贸digo e o local!");

            const agora = new Date();
            await db.estoque.add({
                codigo_item: item,
                codigo_prateleira: prat,
                data: agora.toLocaleDateString('pt-BR'),
                hora: agora.toLocaleTimeString('pt-BR')
            });

            document.getElementById('item_cod').value = '';
            carregarEstoque();
        }

        // --- LGICA DE PESQUISA ---
        async function pesquisar() {
            const termo = document.getElementById('input_busca').value.trim().toLowerCase();
            const titulo = document.getElementById('titulo_lista');

            if (termo === "") {
                titulo.innerText = "ltimos Lan莽amentos";
                carregarEstoque();
                return;
            }

            titulo.innerText = " Resultados Encontrados";
            const resultados = await db.estoque
                .filter(i => i.codigo_item.toLowerCase().includes(termo))
                .reverse()
                .toArray();
            
            renderizarLista(resultados);
        }

        async function carregarEstoque() {
            const itens = await db.estoque.reverse().limit(10).toArray();
            renderizarLista(itens);
        }

        function renderizarLista(itens) {
            const lista = document.getElementById('lista_estoque');
            if(itens.length === 0) {
                lista.innerHTML = '<p class="text-gray-400 text-center text-sm py-4 italic">Nenhum item encontrado.</p>';
                return;
            }
            lista.innerHTML = itens.map(i => `
                <div class="bg-white p-3 rounded-lg border shadow-sm flex justify-between items-center registro-card">
                    <div>
                        <div class="font-mono font-bold text-gray-800 text-base">${i.codigo_item}</div>
                        <div class="text-blue-600 text-[11px] font-bold uppercase">${i.codigo_prateleira}</div>
                    </div>
                    <div class="text-right text-gray-400 text-[10px]">
                        ${i.data}<br>${i.hora}
                    </div>
                </div>
            `).join('');
        }

        function iniciarScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                document.getElementById('item_cod').value = text;
                html5QrCode.stop();
                registrarEstoque();
            }).catch(err => console.error(err));
        }

        function exportarDados() {
            db.estoque.toArray().then(dados => {
                const blob = new Blob([JSON.stringify(dados, null, 2)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `estoque.json`;
                a.click();
            });
        }
    </script>
</body>
</html>